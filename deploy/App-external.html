<!DOCTYPE html>
<html>
<head>
    <title>TimeInState</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                !function(){var e=window.Ext4||window.Ext,t=null;e.define("typesToChoose",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"_ref",type:"string"},{name:"lbapi",type:"string"},{name:"field",type:"string"}],getNonCollectionFields:function(){return this.fields}}),e.define("Niks.Apps.TimeInState",{extend:"Rally.app.App",alias:"widget.tisApp",componentCls:"app",stateful:!0,typeStore:null,itemId:"rallyApp",id:"rallyApp",config:{defaultSettings:{artefactType:"hierarchicalrequirement",piType:"Portfolioitem/Feature"}},getSettingsFields:function(){return[{xtype:"rallycombobox",name:"artefactType",fieldLabel:"Artefact Type:",storeType:"Ext.data.Store",store:this.store,displayField:"name",labelAlign:"right",labelWidth:150},{xtype:"rallyportfolioitemtypecombobox",fieldLabel:"PI Type (if selected):",name:"piType",labelAlign:"right",labelWidth:150,valueField:"TypePath"}]},items:[{xtype:"container",id:"headerBox",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"},items:[{xtype:"rallydatefield",margin:10,format:"D d M Y",id:"StartDate",stateful:!0,fieldLabel:"Start Date",value:e.Date.subtract(new Date,e.Date.DAY,90)},{xtype:"rallydatefield",margin:10,fieldLabel:"End Date",format:"D d M Y",stateful:!0,id:"EndDate",value:new Date}]}],_getCalculatorConfig:function(){return{endDate:e.getCmp("EndDate").getValue(),startDate:e.getCmp("StartDate").getValue(),granularity:"day"}},_getSeriesData:function(a){var i=_.find(this.possibleTypes,{_ref:a.artefactType}).lbapi;"PortfolioItem"===i&&(i=a.piType);var o=t.down("#fieldCombo").value;e.create("Rally.data.lookback.SnapshotStore",{autoLoad:!1,defaultFetch:["ObjectID","_ValidFrom","_ValidTo"],compress:!0,removeUnauthorizedSnapshots:!0,pageSize:15e3,fetch:[o],hydrate:[o],filters:[{property:"_TypeHierarchy",operator:"in",value:[i]},{property:o,operator:"in",value:a.categoryData},{property:"_ValidFrom",operator:">",value:e.Date.format(e.getCmp("StartDate").value,"Y-m-d\\TH:i:s.u\\Z")},{property:"_ValidTo",operator:"<",value:e.Date.format(e.getCmp("EndDate").value,"Y-m-d\\TH:i:s.u\\Z")}],sorters:[{property:"ObjectID",direction:"ASC"},{property:"_ValidFrom",direction:"ASC"}],listeners:{load:a._gotSnapShots,scope:a},storeConfig:{limit:1/0}}).load()},_findItem:function(e,t){var a=_.keys(t),i=a.length;if(null!==e&&0!==i)for(var o=0;o<e.length;o++){var r=e[o],l=Object(r.data),n=0;for(n=0;n<i;n++){var d=a[n];if(t[d]!==l[d]||!(d in l))break}if(n>=i)return r}return null},_gotSnapShots:function(e,t,a){var i=this;console.log("Snapshots received: ",t.length);var o=[],r=e.hydrate[0];_.each(t,function(e){var t=null,a={};a.ObjectID=e.get("ObjectID"),a[r]=e.get(r),d1=new Date(e.get("_ValidFrom")),d2=new Date(e.get("_ValidTo")),(t=i._findItem(o,a))?(d_=t.get("TimeDiff"),d3=d_||0,t.set("TimeDiff",d3+(d2-d1))):(e.set("TimeDiff",d2-d1),o.push(e))}),console.log("Saved items: ",o);for(var l=0;l<i.categoryData.length;l++)console.log("Creating artefactData array for ",i.categoryData[l]),i.artefactData[l]=[];_.each(o,function(e){""===e.data[r]&&(e.data[r]="None"),(index=i.categoryData.indexOf(e.data[r]))>=0&&e.data.TimeDiff>36e5&&i.artefactData[index].push(e.data.TimeDiff)});var n=[];_.each(i.artefactData,function(e){sortedArray=_.sortBy(e);var t=[],a=0,i=0;if(e.length>0){for(i=0;i<e.length;i++)a+=e[i];t.push(Math.floor(_.min(e)/864e3)/100),t.push(Math.floor(sortedArray[Math.floor(.25*i)]/864e3)/100),t.push(Math.floor(a/(864e3*e.length))/100),t.push(Math.floor(sortedArray[Math.floor(.75*i)]/864e3)/100),t.push(Math.floor(_.max(e)/864e3)/100),n.push(t)}}),i.seriesData=[{name:r,data:n}],i._drawChart()},artefactType:null,artefactData:{},categoryData:[],seriesData:[],possibleTypes:[{name:"Stories",_ref:"hierarchicalrequirement",lbapi:"HierarchicalRequirement",field:"ScheduleState"},{name:"Defects",_ref:"defect",lbapi:"Defect",field:"ScheduleState"},{name:"Tasks",_ref:"task",lbapi:"Task",field:"State"},{name:"TestCases",_ref:"testcase",lbapi:"TestCase",field:"LastVerdict"},{name:"Portfolio",_ref:"portfolioitem",lbapi:"PortfolioItem",field:"State"}],_restart:function(){var a=null;(a=e.getCmp("tipChart"))&&a.destroy(),t.artefactData={},t.seriesData=[],t.categoryData=e.getCmp("fieldValueCombo").value,t._getSeriesData(t)},_drawChart:function(){var t=e.create("Rally.ui.chart.Chart",{id:"tipChart",loadMask:!1,chartData:{categories:this.categoryData,series:this.seriesData},chartConfig:{chart:{type:"boxplot",marginRight:130,marginBottom:25},title:{text:"Time In State for Period",x:-20},subtitle:{text:"Min, 25%, Average, 75%, Max",x:-20},yAxis:{min:0,title:{text:"Days in State"}},plotOptions:{columnrange:{dataLabels:{enabled:!0,formatter:function(){return this.y+"days"}}}},legend:{enabled:!1}}});this.add(t)},onSettingsUpdate:function(){this._kickOff()},_getFieldComboBoxConfig:function(a){var i=a._ref;return"portfolioitem"===i&&(i=this.piType.toLowerCase()),{xtype:"rallyfieldcombobox",model:i,autoScroll:!0,stateful:!0,stateId:e.id()+"fieldCombo",fieldLabel:a.name+" Field:",id:"fieldCombo",margin:10,listeners:{ready:function(e){e.store.filterBy(function(e){var t=e.get("fieldDefinition").attributeDefinition;return t&&t.Constrained&&"COLLECTION"!==t.AttributeType}),t.fireEvent("storeFiltered")},select:function(e){t.down("#fieldValueCombo").fireEvent("fieldselected",e.getRecord().get("fieldDefinition"))}},allowNoEntry:!1,allowBlank:!1}},_getFieldValueComboBoxConfig:function(){var a=t.down("#fieldCombo");a.getValue();return{xtype:"rallyfieldvaluecombobox",id:"fieldValueCombo",model:a.getModel().typePath,stateful:!0,stateId:e.id()+"fieldValueCombo",field:a.getValue(),fieldLabel:a.getRawValue()+" Values: ",labelWidth:150,valueField:"name",multiSelect:!0,margin:10,allowNoEntry:!1,allowBlank:!1,listeners:{fieldselected:function(e){this.setField(e),this.setFieldLabel(a.getRawValue()+" Values: ")},setvalue:function(e,a){t.fireEvent("fieldValuesSelected")}}}},_createFieldValueCombo:function(){var t=this.down("#fieldValueCombo");t&&t.destroy();var a=this._getFieldValueComboBoxConfig(),i=e.create("Rally.ui.combobox.FieldValueComboBox",a);this.down("#headerBox").add(i)},_createFieldCombo:function(){var t=this.down("#fieldCombo");t&&t.destroy();var a=_.find(this.possibleTypes,{_ref:this.artefactType}),i=this._getFieldComboBoxConfig(a),o=e.create("Rally.ui.combobox.FieldComboBox",i);this.down("#headerBox").add(o)},launch:function(){t=this,this.store=e.create("Ext.data.Store",{model:"typesToChoose",data:t.possibleTypes,proxy:"memory",autoLoad:!1}),this.addListener({storeFiltered:function(){this._createFieldValueCombo()}}),this.addListener({fieldValuesSelected:function(){this._resetTimer(this._restart)}}),this._kickOff()},_kickOff:function(){this.artefactType=this.getSetting("artefactType")||"hierarchicalrequirement",this.piType=this.getSetting("piType")||"Portfolioitem/Feature",e.getCmp("StartDate").on("change",t._restart,t),e.getCmp("EndDate").on("change",t._restart,t),this._createFieldCombo()},_resetTimer:function(e){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(e,2e3)}})}();

            Rally.launchApp('Niks.Apps.TimeInState', {
                name:"TimeInState",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
