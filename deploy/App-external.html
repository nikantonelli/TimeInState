<!DOCTYPE html>
<html>
<head>
    <title>TimeInState</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("typesToChoose",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"_ref",type:"string"},{name:"lbapi",type:"string"},{name:"field",type:"string"}],getNonCollectionFields:function(){return this.fields}}),Ext.define("Rally.app.CustomApp",{extend:"Rally.app.App",componentCls:"app",id:"tipApp",stateful:!0,settingsScope:"project",typeStore:null,getSettingsFields:function(){var returnVal=[{xtype:"rallycombobox",name:"artefactType",fieldLabel:"Artefact Type:",stateful:!0,stateId:"afcombo-"+Ext.id(),storeType:"Ext.data.Store",store:this.store,displayField:"name",labelAlign:"right",labelWidth:150},{xtype:"rallyportfolioitemtypecombobox",fieldLabel:"PI Type (if selected):",stateful:!0,stateId:"picombo-"+Ext.id(),name:"piType",labelAlign:"right",labelWidth:150,valueField:"_refObjectName"}];return returnVal},items:[{xtype:"container",id:"headerBox",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"},items:[{xtype:"rallydatefield",margin:10,format:"D d M Y",id:"StartDate",stateful:!0,fieldLabel:"Start Date",value:Ext.Date.subtract(new Date,Ext.Date.DAY,90)},{xtype:"rallydatefield",margin:10,fieldLabel:"End Date",format:"D d M Y",stateful:!0,id:"EndDate",value:new Date}]}],_getCalculatorConfig:function(){return{endDate:Ext.getCmp("EndDate").getValue(),startDate:Ext.getCmp("StartDate").getValue(),granularity:"day"}},_getSeriesData:function(app){var typeRecord=_.where(this.possibleTypes,{_ref:app.artefactType}),typeName=typeRecord[0].lbapi;"PortfolioItem"===typeName&&(typeName+="/"+app.piType);var snapshots=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!1,defaultFetch:["ObjectID","_ValidFrom","_ValidTo"],compress:!0,fetch:["FormattedID","Name",typeRecord[0].field],hydrate:[typeRecord[0].field],filters:[{property:"_TypeHierarchy",operator:"in",value:[typeName]},{property:"_ValidFrom",operator:">",value:Ext.Date.format(Ext.getCmp("StartDate").value,"Y-m-d\\TH:i:s.u\\Z")},{property:"_ValidTo",operator:"<",value:Ext.Date.format(Ext.getCmp("EndDate").value,"Y-m-d\\TH:i:s.u\\Z")}],sorters:[{property:"ObjectID",direction:"ASC"},{property:"_ValidFrom",direction:"ASC"}],listeners:{load:app._gotSnapShots,scope:app},storeConfig:{limit:1/0}});snapshots.load()},_findItem:function(data,fieldsToMatch){var keys=_.keys(fieldsToMatch),keylength=keys.length;if(null===data||0===keylength)return null;for(var j=0;j<data.length;j++){var record=data[j],obj=Object(record.data),i=0;for(i=0;i<keylength;i++){var key=keys[i];if(fieldsToMatch[key]!==obj[key]||!(key in obj))break}if(i>=keylength)return record}return null},_gotSnapShots:function(store,data,success){var app=this,lastDataItem=null,savedItems=[],hydratedField=store.hydrate[0];_.each(data,function(item){var foundItem=null,findThese={};findThese.ObjectID=item.get("ObjectID"),findThese[hydratedField]=item.get(hydratedField),d1=new Date(item.get("_ValidFrom")),d2=new Date(item.get("_ValidTo")),(foundItem=app._findItem(savedItems,findThese))?(d_=foundItem.get("TimeDiff"),d3=d_?d_:0,foundItem.set("TimeDiff",d3+(d2-d1))):(item.set("TimeDiff",d2-d1),savedItems.push(item))});for(var i=0;i<app.categoryData.length;i++)app.artefactData[i]=[];_.each(savedItems,function(item){""===item.data[hydratedField]&&(item.data[hydratedField]="None"),(index=app.categoryData.indexOf(item.data[hydratedField]))>=0&&item.data.TimeDiff>36e5&&app.artefactData[index].push(item.data.TimeDiff)});var dataArray=[];_.each(app.artefactData,function(adArray){sortedArray=_.sortBy(adArray);var stats=[],sum=0,i=0;if(adArray.length>0){for(i=0;i<adArray.length;i++)sum+=adArray[i];stats.push(Math.floor(_.min(adArray)/864e3)/100),stats.push(Math.floor(sortedArray[Math.floor(.25*i)]/864e3)/100),stats.push(Math.floor(sum/(864e3*adArray.length))/100),stats.push(Math.floor(sortedArray[Math.floor(.75*i)]/864e3)/100),stats.push(Math.floor(_.max(adArray)/864e3)/100),dataArray.push(stats)}}),app.seriesData=[{name:hydratedField,data:dataArray}],app._drawChart()},artefactType:null,artefactData:{},categoryData:[],seriesData:[],possibleTypes:[{name:"Stories",_ref:"hierarchicalrequirement",lbapi:"HierarchicalRequirement",field:"ScheduleState"},{name:"Defects",_ref:"defect",lbapi:"Defect",field:"ScheduleState"},{name:"Tasks",_ref:"task",lbapi:"Task",field:"State"},{name:"TestCases",_ref:"testcase",lbapi:"TestCase",field:"LastVerdict"},{name:"Portfolio",_ref:"portfolioitem",lbapi:"PortfolioItem",field:"State"}],_redrawChart:function(){var chart=null;(chart=Ext.getCmp("tipChart"))&&chart.destroy(),this.artefactData={},this.seriesData=[],this.categoryData=Ext.getCmp("fieldValues").value,this._getSeriesData(this)},_drawChart:function(){var hc=Ext.create("Rally.ui.chart.Chart",{id:"tipChart",loadMask:!1,chartData:{categories:this.categoryData,series:this.seriesData},chartConfig:{chart:{type:"boxplot",marginRight:130,marginBottom:25},title:{text:"Time In State for Period",x:-20},subtitle:{text:"Min, 25%, Average, 75%, Max",x:-20},yAxis:{min:0,title:{text:"Days in State"}},plotOptions:{columnrange:{dataLabels:{enabled:!0,formatter:function(){return this.y+"days"}}}},legend:{enabled:!1}}});this.add(hc)},_checkAndRedrawChart:function(type){var typeRecord=_.where(this.possibleTypes,{_ref:this.artefactType});typeRecord[0].field=type.name,this._redrawChart()},launch:function(){var app=this;Ext.util.Observable.capture(app,function(event){console.log("app:",event)}),Ext.getCmp("StartDate").on("change",app._redrawChart,this),Ext.getCmp("EndDate").on("change",app._redrawChart,this),this.store=Ext.create("Ext.data.Store",{model:"typesToChoose",data:app.possibleTypes,proxy:"memory",autoLoad:!1}),app.artefactType=app.getSetting("artefactType"),app.piType=app.getSetting("piType");var typeRecord=_.where(this.possibleTypes,{_ref:app.artefactType});if(!app.artefactType||!this.piType){app.artefactType="hierarchicalrequirement",typeRecord=_.where(this.possibleTypes,{_ref:app.artefactType});var cc=Ext.create("Ext.container.Container",{items:[{xtype:"text",minWidth:500,margin:10,text:"Using "+typeRecord[0].name+' (Please <save> your preference through the "Edit App Settings" menu option)'}]});Ext.getCmp("headerBox").add(cc)}var typeName=typeRecord[0]._ref;"portfolioitem"===typeName&&(typeName+="/"+app.piType.toLowerCase());var fieldSelector=Ext.create("Rally.ui.combobox.FieldComboBox",{model:typeName,autoScroll:!0,stateful:!0,stateId:this.getContext().getScopedStateId("fieldcombo"),fieldLabel:typeRecord[0].name+" Field:",id:"fieldSelection",margin:10,listeners:{select:function(combo){app.saveState(),typeRecord[0].field=combo.getRecord().get("fieldDefinition").name,Ext.getCmp("fieldValues").fireEvent("fieldselected",combo.getRecord().get("fieldDefinition"))},ready:function(combo){combo.store.filterBy(function(record){var attr=record.get("fieldDefinition").attributeDefinition;return attr&&attr.Constrained&&"COLLECTION"!==attr.AttributeType}),combo.setValue(typeRecord[0].field)}}});Ext.getCmp("headerBox").add(fieldSelector);var fieldValueSelector=Ext.create("Rally.ui.combobox.FieldValueComboBox",{id:"fieldValues",model:typeName,stateful:!0,stateId:this.getContext().getScopedStateId("fieldvaluecombo"),field:typeRecord[0].field,fieldLabel:"Field Values: ",valueField:"name",multiSelect:!0,margin:10,listeners:{fieldselected:function(type){this.setField(type),app.saveState()},ready:function(combo){combo.store.on("load",app._redrawChart,app),this.fireEvent("fieldValuesSelected")}},bubbleEvents:["fieldValuesSelected"]});Ext.getCmp("headerBox").add(fieldValueSelector),Ext.util.Observable.capture(fieldSelector,function(event){console.log("field:",event)}),Ext.util.Observable.capture(fieldValueSelector,function(event){console.log("value:",event)}),this.on("fieldValuesSelected",app._redrawChart,this),Ext.getCmp("headerBox").add({xtype:"rallybutton",text:"Redraw",margin:10,handler:this._redrawChart,scope:this})}});

            Rally.launchApp('Rally.app.CustomApp', {
                name:"TimeInState",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
