<!DOCTYPE html>
<html>
<head>
    <title>TimeInState</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("typesToChoose",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"_ref",type:"string"},{name:"lbapi",type:"string"},{name:"field",type:"string"}],getNonCollectionFields:function(){return this.fields}}),Ext.define("Rally.app.CustomApp",{extend:"Rally.app.App",componentCls:"app",stateful:!0,typeStore:null,config:{defaultSettings:{artefactType:"hierarchicalrequirement",piType:"Portfolioitem/Feature"}},getSettingsFields:function(){return[{xtype:"rallycombobox",name:"artefactType",fieldLabel:"Artefact Type:",stateful:!0,stateId:this.getContext().getScopedStateId("artefactcombo"),storeType:"Ext.data.Store",store:this.store,displayField:"name",labelAlign:"right",labelWidth:150},{xtype:"rallyportfolioitemtypecombobox",fieldLabel:"PI Type (if selected):",stateful:!0,stateId:this.getContext().getScopedStateId("picombo"),name:"piType",labelAlign:"right",labelWidth:150,valueField:"TypePath"}]},items:[{xtype:"container",id:"headerBox",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"},items:[{xtype:"rallydatefield",margin:10,format:"D d M Y",id:"StartDate",stateful:!0,fieldLabel:"Start Date",value:Ext.Date.subtract(new Date,Ext.Date.DAY,90)},{xtype:"rallydatefield",margin:10,fieldLabel:"End Date",format:"D d M Y",stateful:!0,id:"EndDate",value:new Date}]}],_getCalculatorConfig:function(){return{endDate:Ext.getCmp("EndDate").getValue(),startDate:Ext.getCmp("StartDate").getValue(),granularity:"day"}},_getSeriesData:function(e){var t=_.find(this.possibleTypes,{_ref:e.artefactType}),a=t.lbapi;"PortfolioItem"===a&&(a=e.piType),Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!1,defaultFetch:["ObjectID","_ValidFrom","_ValidTo"],compress:!0,removeUnauthorizedSnapshots:!0,pageSize:15e3,fetch:["FormattedID","Name",t.field,"_PreviousValues."+t.field],hydrate:[t.field,"_PreviousValues."+t.field],filters:[{property:"_TypeHierarchy",operator:"in",value:[a]},{property:"_PreviousValues."+t.field,operator:"in",value:e.categoryData},{property:"_ValidFrom",operator:">",value:Ext.Date.format(Ext.getCmp("StartDate").value,"Y-m-d\\TH:i:s.u\\Z")},{property:"_ValidTo",operator:"<",value:Ext.Date.format(Ext.getCmp("EndDate").value,"Y-m-d\\TH:i:s.u\\Z")}],sorters:[{property:"ObjectID",direction:"ASC"},{property:"_ValidFrom",direction:"ASC"}],listeners:{load:e._gotSnapShots,scope:e},storeConfig:{limit:1/0}}).load()},_findItem:function(e,t){var a=_.keys(t),r=a.length;if(null!==e&&0!==r)for(var i=0;i<e.length;i++){var o=e[i],l=Object(o.data),d=0;for(d=0;d<r;d++){var n=a[d];if(t[n]!==l[n]||!(n in l))break}if(d>=r)return o}return null},_gotSnapShots:function(e,t,a){var r=this;console.log("Snapshots received: ",t.length);var i=[],o=e.hydrate[0];_.each(t,function(e){var t=null,a={};a.ObjectID=e.get("ObjectID"),a[o]=e.get(o),d1=new Date(e.get("_ValidFrom")),d2=new Date(e.get("_ValidTo")),(t=r._findItem(i,a))?(d_=t.get("TimeDiff"),d3=d_||0,t.set("TimeDiff",d3+(d2-d1))):(e.set("TimeDiff",d2-d1),i.push(e))}),console.log("Saved items: ",i);for(var l=0;l<r.categoryData.length;l++)console.log("Creating artefactData array for ",r.categoryData[l]),r.artefactData[l]=[];_.each(i,function(e){""===e.data[o]&&(e.data[o]="None"),(index=r.categoryData.indexOf(e.data[o]))>=0&&e.data.TimeDiff>36e5&&r.artefactData[index].push(e.data.TimeDiff)});var d=[];_.each(r.artefactData,function(e){sortedArray=_.sortBy(e);var t=[],a=0,r=0;if(e.length>0){for(r=0;r<e.length;r++)a+=e[r];t.push(Math.floor(_.min(e)/864e3)/100),t.push(Math.floor(sortedArray[Math.floor(.25*r)]/864e3)/100),t.push(Math.floor(a/(864e3*e.length))/100),t.push(Math.floor(sortedArray[Math.floor(.75*r)]/864e3)/100),t.push(Math.floor(_.max(e)/864e3)/100),d.push(t)}}),r.seriesData=[{name:o,data:d}],r._drawChart()},artefactType:null,artefactData:{},categoryData:[],seriesData:[],possibleTypes:[{name:"Stories",_ref:"hierarchicalrequirement",lbapi:"HierarchicalRequirement",field:"ScheduleState"},{name:"Defects",_ref:"defect",lbapi:"Defect",field:"ScheduleState"},{name:"Tasks",_ref:"task",lbapi:"Task",field:"State"},{name:"TestCases",_ref:"testcase",lbapi:"TestCase",field:"LastVerdict"},{name:"Portfolio",_ref:"portfolioitem",lbapi:"PortfolioItem",field:"State"}],_redrawChart:function(){var e=null;(e=Ext.getCmp("tipChart"))&&e.destroy(),this.artefactData={},this.seriesData=[],this.categoryData=Ext.getCmp("fieldValues").value,console.log("Setting category data of: ",this," to ",this.categoryData),this._getSeriesData(this)},_drawChart:function(){var e=Ext.create("Rally.ui.chart.Chart",{id:"tipChart",loadMask:!1,chartData:{categories:this.categoryData,series:this.seriesData},chartConfig:{chart:{type:"boxplot",marginRight:130,marginBottom:25},title:{text:"Time In State for Period",x:-20},subtitle:{text:"Min, 25%, Average, 75%, Max",x:-20},yAxis:{min:0,title:{text:"Days in State"}},plotOptions:{columnrange:{dataLabels:{enabled:!0,formatter:function(){return this.y+"days"}}}},legend:{enabled:!1}}});this.add(e)},launch:function(){var e=this;Ext.getCmp("StartDate").on("change",e._redrawChart,e),Ext.getCmp("EndDate").on("change",e._redrawChart,e),this.store=Ext.create("Ext.data.Store",{model:"typesToChoose",data:e.possibleTypes,proxy:"memory",autoLoad:!1}),e.artefactType=e.getSetting("artefactType")||"hierarchicalrequirement",e.piType=e.getSetting("piType")||"Portfolioitem/Feature";var t=_.find(this.possibleTypes,{_ref:e.artefactType}),a=t._ref;"portfolioitem"===a&&(a=e.piType.toLowerCase());var r=Ext.create("Rally.ui.combobox.FieldComboBox",{model:a,autoScroll:!0,stateful:!0,stateId:this.getContext().getScopedStateId("fieldcombo"),fieldLabel:t.name+" Field:",id:"fieldSelection",margin:10,listeners:{select:function(a){e.saveState(),t.field=a.getRecord().get("fieldDefinition").name,Ext.getCmp("fieldValues").fireEvent("fieldselected",a.getRecord().get("fieldDefinition"))},ready:function(e){e.store.filterBy(function(e){var t=e.get("fieldDefinition").attributeDefinition;return t&&t.Constrained&&"COLLECTION"!==t.AttributeType}),e.setValue(t.field)}}});Ext.getCmp("headerBox").add(r),e.on("fieldValuesSelected",e._redrawChart,e);var i=Ext.create("Rally.ui.combobox.FieldValueComboBox",{id:"fieldValues",model:a,stateful:!0,stateId:this.getContext().getScopedStateId("fieldvaluecombo"),field:t.field,fieldLabel:"Field Values: ",valueField:"name",multiSelect:!0,margin:10,listeners:{fieldselected:function(t){this.setField(t),e.saveState()}}});Ext.getCmp("headerBox").add(i),Ext.getCmp("headerBox").add({xtype:"rallybutton",text:"Draw",margin:10,handler:e._redrawChart,scope:e})}});

            Rally.launchApp('Rally.app.CustomApp', {
                name:"TimeInState",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
